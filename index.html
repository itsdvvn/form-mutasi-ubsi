<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Pengajuan Mutasi UBSI</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel for JSX -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        @media print {
            .no-print { display: none !important; }
            .print-area { 
                box-shadow: none !important; 
                margin: 0 !important; 
                padding: 0 !important;
                width: 100% !important;
            }
            @page { margin: 20mm; size: A4; }
        }

        /* Custom scrollbar for better UX */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        input[type=range] { accent-color: #2563eb; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // Komponen Input Field Standar
        const Field = React.memo(({ label, name, value, onChange, placeholder, type = "text", full = false }) => (
            <div className={full ? "col-span-full space-y-1" : "space-y-1"}>
                <label className="text-xs font-bold text-slate-600 uppercase">{label}</label>
                <input 
                    name={name} 
                    type={type}
                    value={value} 
                    onChange={onChange} 
                    placeholder={placeholder}
                    className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all bg-white"
                />
            </div>
        ));

        // MODAL UNTUK EDIT TANDA TANGAN
        const SignatureModal = ({ isOpen, onClose, originalImg, threshold, setThreshold, scale, setScale, offset, setOffset, processedSig, onAutoTrim }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm no-print">
                    <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        {/* Header */}
                        <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                            <h2 className="font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="pen-tool" className="w-5 h-5 text-blue-600"></i>
                                Signature Studio
                            </h2>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition-colors">
                                <i data-lucide="x" className="w-5 h-5 text-slate-500"></i>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6 space-y-8">
                            {/* Preview Area */}
                            <div className="space-y-2">
                                <label className="text-xs font-bold text-slate-500 uppercase">Preview Hasil Pemrosesan</label>
                                <div className="bg-slate-100 border-2 border-dashed border-slate-300 rounded-xl h-48 flex items-center justify-center overflow-hidden relative">
                                    <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'radial-gradient(#000 1px, transparent 1px)', backgroundSize: '20px 20px' }}></div>
                                    <img 
                                        src={processedSig} 
                                        className="relative z-10 max-h-full max-w-full drop-shadow-sm" 
                                        style={{ transform: `scale(${scale})` }}
                                        alt="Processed Signature" 
                                    />
                                </div>
                            </div>

                            {/* Controls */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="space-y-4">
                                    <div className="space-y-2">
                                        <div className="flex justify-between">
                                            <label className="text-xs font-bold text-slate-700 uppercase">Toleransi Background</label>
                                            <span className="text-xs font-bold text-blue-600">{threshold}</span>
                                        </div>
                                        <input type="range" min="30" max="230" value={threshold} onChange={(e) => setThreshold(parseInt(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                                        <p className="text-[10px] text-slate-400 italic">Bersihkan bayangan & garis kertas.</p>
                                    </div>

                                    <div className="space-y-2">
                                        <div className="flex justify-between">
                                            <label className="text-xs font-bold text-slate-700 uppercase">Ukuran Tanda Tangan</label>
                                            <span className="text-xs font-bold text-blue-600">{Math.round(scale * 100)}%</span>
                                        </div>
                                        <input type="range" min="0.5" max="3" step="0.1" value={scale} onChange={(e) => setScale(parseFloat(e.target.value))} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    <div className="space-y-2">
                                        <div className="flex justify-between">
                                            <label className="text-xs font-bold text-slate-700 uppercase">Posisi Horizontal</label>
                                            <span className="text-xs font-bold text-blue-600">{offset.x}px</span>
                                        </div>
                                        <input type="range" min="-50" max="50" value={offset.x} onChange={(e) => setOffset({...offset, x: parseInt(e.target.value)})} className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                                    </div>
                                    
                                    <div className="pt-2">
                                        <button 
                                            onClick={onAutoTrim}
                                            className="w-full py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded-lg text-xs font-bold hover:bg-blue-100 transition-colors flex items-center justify-center gap-2"
                                        >
                                            <i data-lucide="crop" className="w-4 h-4"></i>
                                            AUTO CROP (TRIM)
                                        </button>
                                        <p className="mt-2 text-[9px] text-slate-400 leading-tight">Otomatis membuang area kosong di pinggir tanda tangan agar lebih fokus.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="p-4 border-t bg-slate-50 flex justify-end">
                            <button 
                                onClick={onClose}
                                className="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md transition-all active:scale-95"
                            >
                                Selesai & Simpan
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [formData, setFormData] = useState({
                tanggal: new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }),
                nama: '',
                nim: '',
                kelas: '',
                email: '',
                noHp: '',
                periodeAsal: 'Maret 2025',
                kampusAsal: '',
                jenjangAsal: 'S1',
                prodiAsal: '',
                peminatanAsal: '',
                waktuAsal: '',
                alasan: '',
                periodeTujuan: 'Maret 2026',
                kampusTujuan: '',
                jenjangTujuan: 'S1',
                prodiTujuan: '',
                peminatanTujuan: '',
                waktuTujuan: '',
            });

            // State Signature
            const [originalImg, setOriginalImg] = useState(null);
            const [processedSig, setProcessedSig] = useState(null);
            const [threshold, setThreshold] = useState(150);
            const [scale, setScale] = useState(1.0);
            const [offset, setOffset] = useState({ x: 0, y: 0 });
            const [isModalOpen, setIsModalOpen] = useState(false);

            useEffect(() => { lucide.createIcons(); }, [originalImg, isModalOpen, processedSig]);

            const handleChange = useCallback((e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            }, []);

            // Pemrosesan gambar utama
            const processImage = (imgElement, currentThreshold) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = imgElement.width;
                canvas.height = imgElement.height;
                ctx.drawImage(imgElement, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                for (let i = 0; i < data.length; i += 4) {
                    const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                    if (gray > currentThreshold) {
                        data[i+3] = 0; 
                    } else {
                        data[i] = 0; data[i+1] = 0; data[i+2] = 0; data[i+3] = 255;
                    }
                }
                ctx.putImageData(imageData, 0, 0);
                return canvas;
            };

            // Fungsi Auto Crop (Trim Whitespace)
            const handleAutoTrim = () => {
                if (!originalImg) return;
                
                const canvas = processImage(originalImg, threshold);
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                const width = canvas.width;
                const height = canvas.height;

                let minX = width, minY = height, maxX = 0, maxY = 0;
                let found = false;

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const alpha = data[(y * width + x) * 4 + 3];
                        if (alpha > 0) {
                            if (x < minX) minX = x;
                            if (y < minY) minY = y;
                            if (x > maxX) maxX = x;
                            if (y > maxY) maxY = y;
                            found = true;
                        }
                    }
                }

                if (!found) return;

                const padding = 10;
                minX = Math.max(0, minX - padding);
                minY = Math.max(0, minY - padding);
                maxX = Math.min(width, maxX + padding);
                maxY = Math.min(height, maxY + padding);

                const cropW = maxX - minX;
                const cropH = maxY - minY;

                const trimCanvas = document.createElement('canvas');
                trimCanvas.width = cropW;
                trimCanvas.height = cropH;
                trimCanvas.getContext('2d').drawImage(canvas, minX, minY, cropW, cropH, 0, 0, cropW, cropH);
                
                // Gunakan hasil trim sebagai "image baru" untuk diproses selanjutnya
                const trimmedImg = new Image();
                trimmedImg.onload = () => {
                    setOriginalImg(trimmedImg);
                    setScale(1.2); // Set default scale sedikit lebih besar setelah crop
                };
                trimmedImg.src = trimCanvas.toDataURL('image/png');
            };

            // Trigger re-processing saat threshold berubah
            useEffect(() => {
                if (originalImg) {
                    const canvas = processImage(originalImg, threshold);
                    setProcessedSig(canvas.toDataURL('image/png'));
                }
            }, [threshold, originalImg]);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            setOriginalImg(img);
                            setIsModalOpen(true);
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <SignatureModal 
                        isOpen={isModalOpen}
                        onClose={() => setIsModalOpen(false)}
                        originalImg={originalImg}
                        threshold={threshold} setThreshold={setThreshold}
                        scale={scale} setScale={setScale}
                        offset={offset} setOffset={setOffset}
                        processedSig={processedSig}
                        onAutoTrim={handleAutoTrim}
                    />

                    <div className="max-w-7xl mx-auto flex flex-col lg:flex-row gap-8">
                        {/* FORM KIRI */}
                        <div className="w-full lg:w-5/12 space-y-6 no-print">
                            <div className="bg-white p-6 rounded-2xl shadow-xl border border-slate-200">
                                <div className="flex items-center gap-3 mb-6">
                                    <div className="p-2 bg-blue-100 text-blue-600 rounded-lg"><i data-lucide="file-text"></i></div>
                                    <h1 className="text-xl font-bold text-slate-800">Form Pengajuan Mutasi</h1>
                                </div>

                                <div className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <Field label="Nama Lengkap" name="nama" value={formData.nama} onChange={handleChange} placeholder="Muhammad..." />
                                        <Field label="NIM" name="nim" value={formData.nim} onChange={handleChange} placeholder="1221xxxx" />
                                        <Field label="Kelas" name="kelas" value={formData.kelas} onChange={handleChange} placeholder="12.4A.01" />
                                        <Field label="No HP" name="noHp" value={formData.noHp} onChange={handleChange} placeholder="0812xxx" />
                                        <div className="space-y-1">
                                            <label className="text-xs font-bold text-slate-600 uppercase">Periode Asal</label>
                                            <select name="periodeAsal" value={formData.periodeAsal} onChange={handleChange} className="w-full p-2 border border-slate-300 rounded-lg outline-none text-sm bg-white">
                                                <option>Maret 2025</option><option>September 2025</option>
                                            </select>
                                        </div>
                                        <Field label="Prodi Asal" name="prodiAsal" value={formData.prodiAsal} onChange={handleChange} placeholder="Ilmu Komunikasi" />
                                        <Field label="Peminatan Asal" name="peminatanAsal" value={formData.peminatanAsal} onChange={handleChange} placeholder="Public Relations" />
                                        <Field label="Kampus Asal" name="kampusAsal" value={formData.kampusAsal} onChange={handleChange} placeholder="UBSI Cengkareng" />
                                    </div>

                                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-4">
                                        <h3 className="font-bold text-blue-800 text-sm flex items-center gap-2"><i data-lucide="map-pin" className="w-4 h-4"></i> Rencana Pindah 2026</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="space-y-1">
                                                <label className="text-xs font-bold text-slate-600 uppercase">Periode</label>
                                                <select name="periodeTujuan" value={formData.periodeTujuan} onChange={handleChange} className="w-full p-2 border border-slate-300 rounded-lg outline-none text-sm bg-white">
                                                    <option>Maret 2026</option><option>September 2026</option>
                                                </select>
                                            </div>
                                            <Field label="Kampus Tujuan" name="kampusTujuan" value={formData.kampusTujuan} onChange={handleChange} placeholder="UBSI Margonda" />
                                            <Field label="Prodi Tujuan" name="prodiTujuan" value={formData.prodiTujuan} onChange={handleChange} placeholder="Ilmu Komunikasi" />
                                            <Field label="Peminatan Tujuan" name="peminatanTujuan" value={formData.peminatanTujuan} onChange={handleChange} placeholder="Public Relations" />
                                        </div>
                                    </div>

                                    {/* Signature Upload Area */}
                                    <div className="space-y-2">
                                        <label className="text-xs font-bold text-slate-600 uppercase">Tanda Tangan</label>
                                        <div className="p-4 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50 flex flex-col items-center gap-3">
                                            {originalImg ? (
                                                <div className="flex flex-col items-center gap-2 w-full">
                                                    <div className="h-20 bg-white border rounded-lg p-2 flex items-center justify-center overflow-hidden w-full relative">
                                                        <img src={processedSig} className="max-h-full" style={{ transform: `scale(${scale}) translateX(${offset.x}px)` }} />
                                                    </div>
                                                    <button 
                                                        onClick={() => setIsModalOpen(true)}
                                                        className="text-xs font-bold text-blue-600 flex items-center gap-1 hover:underline"
                                                    >
                                                        <i data-lucide="settings" className="w-3 h-3"></i> Edit Tanda Tangan (Crop & Scale)
                                                    </button>
                                                </div>
                                            ) : (
                                                <div className="w-full">
                                                    <input type="file" accept="image/*" onChange={handleFileUpload} className="hidden" id="sig-upload" />
                                                    <label htmlFor="sig-upload" className="w-full py-4 bg-white border border-slate-200 rounded-lg flex flex-col items-center cursor-pointer hover:bg-slate-100 transition-colors">
                                                        <i data-lucide="upload-cloud" className="w-6 h-6 text-slate-400 mb-1"></i>
                                                        <span className="text-[10px] font-bold text-slate-500 uppercase">Upload Foto TTD</span>
                                                    </label>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <button onClick={() => window.print()} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                                        <i data-lucide="printer"></i> Cetak ke PDF
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* PREVIEW SURAT KANAN */}
                        <div className="w-full lg:w-7/12 flex flex-col items-center">
                            <div className="print-area w-full max-w-[210mm] bg-white shadow-2xl p-[18mm] min-h-[297mm] text-[11pt] leading-snug text-black">
                                <div className="text-right mb-10 font-sans">Jakarta, {formData.tanggal}</div>
                                <div className="mb-8">
                                    Kepada YTH.<br />
                                    <span className="font-bold">Ketua Penerimaan Mahasiswa Baru</span><br />
                                    Universitas Bina Sarana Informatika<br />
                                    Di Tempat
                                </div>
                                <div className="font-bold mb-8 uppercase underline decoration-1 underline-offset-4 italic">Perihal : Pengajuan Mutasi</div>
                                <p className="mb-6 text-justify">Saya yang bertanda tangan dibawah ini, telah terdaftar di Universitas Bina Sarana Informatika. Dan Akan mengajukan mutasi. Adapun data saya sebagai berikut :</p>
                                
                                <table className="w-full mb-8">
                                    <tbody>
                                        {[
                                            ['Nama', formData.nama], ['NIM', formData.nim], ['Kelas', formData.kelas],
                                            ['Email', formData.email], ['No Handphone', formData.noHp],
                                            ['Periode kuliah', formData.periodeAsal, true], ['Kampus UBSI cabang', formData.kampusAsal],
                                            ['Jenjang Study', formData.jenjangAsal, true], ['Program Studi', formData.prodiAsal],
                                            ['Peminatan', formData.peminatanAsal]
                                        ].map(([label, val, bold], idx) => (
                                            <tr key={idx}><td className="w-[180px] py-0.5">{label}</td><td className={bold ? 'font-bold' : ''}>: {val || '...................................................'}</td></tr>
                                        ))}
                                    </tbody>
                                </table>

                                <p className="mb-4">Dengan ini mengajukan perpindahan dikarenakan <strong>{formData.alasan || '..........................'}</strong>. Data tujuan mutasi:</p>
                                <table className="w-full mb-10">
                                    <tbody>
                                        {[
                                            ['Periode kuliah', formData.periodeTujuan, true], ['Kampus UBSI cabang', formData.kampusTujuan],
                                            ['Jenjang Study', formData.jenjangTujuan, true], ['Program Studi', formData.prodiTujuan],
                                            ['Peminatan', formData.peminatanTujuan]
                                        ].map(([label, val, bold], idx) => (
                                            <tr key={idx}><td className="w-[180px] py-0.5">{label}</td><td className={bold ? 'font-bold' : ''}>: {val || '...................................................'}</td></tr>
                                        ))}
                                    </tbody>
                                </table>

                                <p className="mb-10">Demikian surat pengajuan mutasi ini dibuat. Atas perhatiannya diucapkan terima kasih.</p>

                                <div className="mt-10 ml-4">
                                    <div>Hormat Saya</div>
                                    <div className="h-28 flex items-center justify-start overflow-hidden relative" style={{ width: '200px' }}>
                                        {processedSig ? (
                                            <img 
                                                src={processedSig} 
                                                className="signature-preview drop-shadow-sm" 
                                                style={{ 
                                                    transform: `scale(${scale}) translateX(${offset.x}px)`,
                                                    transformOrigin: 'left center'
                                                }} 
                                            />
                                        ) : <div className="no-print text-slate-200 italic text-[10px] mt-10">Tanda tangan</div>}
                                    </div>
                                    <div className="font-bold underline uppercase">( {formData.nama || 'Muhammad Wahyudi Setiawan'} )</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
